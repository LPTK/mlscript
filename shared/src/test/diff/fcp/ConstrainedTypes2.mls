
:GeneralizeCurriedFunctions


def f n = n 0
//│ f: (0 -> 'a & 'b) -> 'a
//│  = [Function: f]

:e
f {}
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.10: 	f {}
//│ ║        	^^^^
//│ ╟── record literal of type `anything` is not a function
//│ ║  l.10: 	f {}
//│ ║        	  ^^
//│ ╟── Note: constraint arises from application:
//│ ║  l.5: 	def f n = n 0
//│ ║       	          ^^^
//│ ╟── from reference:
//│ ║  l.5: 	def f n = n 0
//│ ╙──     	          ^
//│ res: error
//│ Runtime error:
//│   TypeError: n is not a function

// :d
:e
f {} {}
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.29: 	f {} {}
//│ ║        	^^^^
//│ ╟── record literal of type `anything` is not a function
//│ ║  l.29: 	f {} {}
//│ ║        	  ^^
//│ ╟── Note: constraint arises from application:
//│ ║  l.5: 	def f n = n 0
//│ ║       	          ^^^
//│ ╟── from reference:
//│ ║  l.5: 	def f n = n 0
//│ ╙──     	          ^
//│ res: error
//│ Runtime error:
//│   TypeError: n is not a function


def f n m = n 0
//│ f: 'a -> (forall 'a, 'b, 'c. ('c -> 'b
//│   where
//│     'a <: 0 -> 'b))
//│  = [Function: f1]

// :e // Error delayed by inconsistent constrained types
f {}
//│ res: 'a -> 'b
//│   where
//│     anything <: 0 -> 'b
//│    = [Function (anonymous)]

:e
f {} {}
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.61: 	f {} {}
//│ ║        	^^^^^^^
//│ ╟── record literal of type `anything` is not a function
//│ ║  l.61: 	f {} {}
//│ ║        	  ^^
//│ ╟── Note: constraint arises from application:
//│ ║  l.47: 	def f n m = n 0
//│ ╙──      	            ^^^
//│ res: error
//│ Runtime error:
//│   TypeError: n is not a function



def test extr =
  let f n m = n 0
  in let _ = extr f
  in f 0
//│ test: ((forall 'a. 'a -> (forall 'a, 'b, 'c, 'd. ('d -> 'c
//│   where
//│     'a <: (0 | 'b) -> 'c))) -> 'e & 'f) -> (forall 'b, 'g, 'h, 'i. ('h -> 'g | 'i
//│   where
//│     0 | 'b <: (0 | 'b) -> 'g))
//│     = [Function: test]

:e
test 1
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.89: 	test 1
//│ ║        	^^^^^^
//│ ╟── integer literal of type `1` is not a function
//│ ║  l.89: 	test 1
//│ ║        	     ^
//│ ╟── Note: constraint arises from application:
//│ ║  l.79: 	  in let _ = extr f
//│ ╙──      	             ^^^^^^
//│ res: error
//│ Runtime error:
//│   TypeError: extr is not a function

// * Note: this extrudes a Constrainedtype referring to a higher-level variable (x)
def test extr x =
  let f n m = x (n 0)
  in let _ = extr f
  in f 0
//│ test: ((forall 'a. 'a -> (forall 'b, 'c, 'd, 'a, 'e, 'f. ('d -> 'b
//│   where
//│     'f <: 'c -> 'b
//│     'a <: (0 | 'e) -> 'c))) -> 'g & 'h) -> (forall 'i. ('f & 'i) -> (forall 'j, 'k, 'l, 'e, 'i, 'm. ('m -> 'l | 'j
//│   where
//│     'i <: 'k -> 'l
//│     0 | 'e <: (0 | 'e) -> 'k)))
//│     = [Function: test1]

:e
test 0
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.118: 	test 0
//│ ║         	^^^^^^
//│ ╟── integer literal of type `0` is not a function
//│ ║  l.118: 	test 0
//│ ║         	     ^
//│ ╟── Note: constraint arises from application:
//│ ║  l.106: 	  in let _ = extr f
//│ ╙──       	             ^^^^^^
//│ res: error
//│    = [Function (anonymous)]

def test extr x =
  let f n m = x (n 0)
  in f 0
//│ test: 'a -> (forall 'b. 'b -> (forall 'c, 'd, 'e, 'b, 'f, 'g. ('e -> 'c | 'f
//│   where
//│     'b <: 'g -> 'c
//│     0 | 'd <: (0 | 'd) -> 'g)))
//│     = [Function: test2]

// Error delayed by inconsistent constrained types
test 0 1
//│ res: 'a -> 'b | 'c
//│   where
//│     1 <: 'd -> 'b
//│     0 | 'e <: (0 | 'e) -> 'd
//│    = [Function (anonymous)]

:e
test 0 1 2
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.149: 	test 0 1 2
//│ ║         	^^^^^^^^^^
//│ ╟── integer literal of type `1` is not a function
//│ ║  l.149: 	test 0 1 2
//│ ║         	       ^
//│ ╟── Note: constraint arises from application:
//│ ║  l.132: 	  let f n m = x (n 0)
//│ ╙──       	              ^^^^^^^
//│ res: error
//│ Runtime error:
//│   TypeError: n is not a function

def test extr x =
  let f n m = (n x 0)
  in f 0
//│ test: 'a -> (forall 'b. 'b -> (forall 'c, 'd, 'e, 'b, 'f, 'g. ('c -> 'e | 'f
//│   where
//│     0 | 'g <: 'b -> ((0 | 'g) -> 'e & 'd))))
//│     = [Function: test3]

// Error delayed by inconsistent constrained types
test 0 1
//│ res: 'a -> 'b | 'c
//│   where
//│     0 | 'd <: 1 -> ((0 | 'd) -> 'b & 'e)
//│    = [Function (anonymous)]

:e
test 0 1 2
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.179: 	test 0 1 2
//│ ║         	^^^^^^^^^^
//│ ╟── integer literal of type `0` is not a function
//│ ║  l.165: 	  in f 0
//│ ║         	       ^
//│ ╟── Note: constraint arises from application:
//│ ║  l.164: 	  let f n m = (n x 0)
//│ ╙──       	               ^^^
//│ res: error
//│ Runtime error:
//│   TypeError: n is not a function


